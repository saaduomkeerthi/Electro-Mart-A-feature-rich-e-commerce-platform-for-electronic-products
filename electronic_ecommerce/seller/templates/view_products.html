<!-- electronic_ecommerce/seller/templates/view_products.html -->

{% extends "base.html" %}

{% block title %}My Products{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">My Products</h1>
        <a href="{{ url_for('seller_bp.add_product_page') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add New Product
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-box-open"></i> All Product Listings</h4>
        </div>
        <div class="card-body">
            <!-- Alert placeholder for delete messages -->
            <div id="delete-alert-placeholder"></div>

            <!-- START: NEW FILTER AND SEARCH FORM -->
            <form id="filter-form" class="row g-3 align-items-center mb-4">
                <div class="col-md-5">
                    <label for="category-filter" class="form-label">Filter by Category</label>
                    <select id="category-filter" class="form-select">
                        <option value="">All My Categories</option>
                        <!-- Categories will be loaded here by JavaScript -->
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="search-input" class="form-label">Search by Name or SKU</label>
                    <input type="search" id="search-input" class="form-control" placeholder="e.g., Gaming Laptop...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
            <!-- END: NEW FILTER AND SEARCH FORM -->
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 10%;">Image</th>
                            <th scope="col" style="width: 30%;">Product Name</th>
                            <th scope="col" style="width: 15%;">SKU</th>
                            <th scope="col" style="width: 10%;">Price</th>
                            <th scope="col" style="width: 10%;">Stock</th>
                            <th scope="col" style="width: 10%;">Status</th>
                            <th scope="col" style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Product rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div id="loading-spinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- START: NEW PAGINATION CONTAINER -->
            <nav id="pagination-container" class="mt-4 d-flex justify-content-center">
                <!-- Pagination links will be rendered here -->
            </nav>
            <!-- END: NEW PAGINATION CONTAINER -->

        </div>
    </div>
</div>

<!-- Delete Confirmation Modal (Unchanged) -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleteModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Product</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {

    // --- 1. REFERENCES & STATE ---
    const tableBody = $('#products-table-body');
    const spinner = $('#loading-spinner');
    const paginationContainer = $('#pagination-container');
    const categoryFilter = $('#category-filter');
    const searchInput = $('#search-input');

    // --- 2. CORE DATA LOADING FUNCTION ---
    function loadProducts(page = 1) {
        spinner.show();
        tableBody.empty();
        paginationContainer.empty();

        const search = searchInput.val();
        const categoryId = categoryFilter.val();

        let apiUrl = `{{ url_for('seller_bp.api_seller_products') }}?page=${page}`;
        if (search) apiUrl += `&search=${search}`;
        if (categoryId) apiUrl += `&category_id=${categoryId}`;

        $.ajax({
            url: apiUrl,
            method: 'GET',
            success: function(response) {
                spinner.hide();
                renderTable(response.products);
                renderPagination(response.total_pages, response.current_page);
            },
            error: function() {
                spinner.hide();
                tableBody.html('<tr><td colspan="7" class="text-center text-danger">Could not load your products.</td></tr>');
            }
        });
    }

    // --- 3. RENDERING FUNCTIONS ---
    function renderTable(products) {
        if (!products || products.length === 0) {
            tableBody.html('<tr><td colspan="7" class="text-center">No products found matching your criteria. <a href="{{ url_for("seller_bp.add_product_page") }}">Add one now!</a></td></tr>');
            return;
        }

        products.forEach(product => {
            let statusBadge;
            if (product.is_approved && product.is_active) {
                statusBadge = '<span class="badge bg-success">Active</span>';
            } else if (!product.is_approved) {
                statusBadge = '<span class="badge bg-warning text-dark">Pending Review</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">Inactive</span>';
            }

            const imageUrl = product.primary_image ? `/${product.primary_image}` : '{{ url_for("static", filename="images/placeholder.png") }}';
            const productName = product.name.length > 50 ? product.name.substring(0, 50) + '...' : product.name;

            const row = `
                <tr id="product-row-${product.product_id}">
                    <td><img src="${imageUrl}" alt="${product.name}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;"></td>
                    <td class="align-middle">${productName}</td>
                    <td class="align-middle">${product.sku}</td>
                    <td class="align-middle">$${parseFloat(product.price).toFixed(2)}</td>
                    <td class="align-middle">${product.stock_quantity}</td>
                    <td class="align-middle">${statusBadge}</td>
                    <td class="align-middle">
                        
                        <div class="d-flex align-items-center">
                            <a href="/seller/edit_product/${product.product_id}" class="btn btn-sm btn-outline-secondary me-1" title="Edit Product">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal" data-productid="${product.product_id}" data-productname="${product.name}" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

    function renderPagination(totalPages, currentPage) {
        if (totalPages <= 1) return;
        let paginationHtml = '<ul class="pagination">';
        paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
        paginationHtml += '</ul>';
        paginationContainer.html(paginationHtml);
    }

    // --- 4. INITIALIZATION FUNCTION ---
    function initializeFilters() {
        $.ajax({
            url: `{{ url_for('seller_bp.api_get_my_categories') }}`,
            method: 'GET',
            success: function(categories) {
                categories.forEach(function(cat) {
                    categoryFilter.append(`<option value="${cat.category_id}">${cat.name}</option>`);
                });
            }
        });
    }

    // --- 5. EVENT LISTENERS ---
    $('#filter-form').on('submit', function(e) {
        e.preventDefault();
        loadProducts(1); // Reset to page 1 for new filters
    });

    paginationContainer.on('click', '.page-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page) loadProducts(page);
    });

    // --- Delete Modal and Logic (Unchanged) ---
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    tableBody.on('click', '.delete-btn', function() {
        const productId = $(this).data('productid');
        const productName = $(this).data('productname');
        $('#deleteModalBody').text(`Are you sure you want to permanently delete the product: "${productName}"? This action cannot be undone.`);
        $('#confirm-delete-btn').data('productId', productId);
    });
    $('#confirm-delete-btn').on('click', function() {
        const productId = $(this).data('productId');
        const deleteBtn = $(this);
        deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Deleting...');
        $.ajax({
            url: `/seller/api/product/${productId}`,
            method: 'DELETE',
            success: function(response) {
                $(`#product-row-${productId}`).fadeOut(500, () => $(this).remove());
                showAlert(response.message, 'success');
                // Reload data in case the current page becomes empty
                const currentPage = parseInt($('.pagination .active .page-link').data('page')) || 1;
                loadProducts(currentPage);
            },
            error: function(xhr) {
                showAlert(xhr.responseJSON.error, 'danger');
            },
            complete: function() {
                deleteModal.hide();
                deleteBtn.prop('disabled', false).text('Delete Product');
            }
        });
    });
    function showAlert(message, type) {
        $('#delete-alert-placeholder').html(`<div class="alert alert-${type} alert-dismissible fade show">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
    }

    // --- 6. INITIAL PAGE LOAD ---
    initializeFilters();
    loadProducts();
});
</script>
{% endblock %}