{% extends "base.html" %}

{% block title %}Seller Dashboard{% endblock %}

{% block head %}
<!-- Chart.js for creating graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Custom styles for the Seller Dashboard stat cards and charts */
    .stat-card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    .stat-card .icon-container {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1.5rem;
        font-size: 1.75rem;
    }
    .stat-card .stat-info h5 {
        margin-bottom: 0.25rem;
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stat-card .stat-info h2 {
        font-weight: 700;
        color: #2d3748;
    }

    /* Color variations for icons */
    .icon-sales { background-color: rgba(67, 97, 238, 0.1); color: var(--primary-color); }
    .icon-listings { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
    .icon-cancellations { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .icon-pending { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
    /* --- NEW ICON STYLE FOR TOTAL PRODUCTS --- */
    .icon-products { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; }


    .card .table th {
        font-weight: 600;
        color: #4a5568;
        border-bottom-width: 1px;
    }
    .card-header h4 {
        font-weight: 600;
        font-size: 1.2rem;
    }
    /* --- NEW STYLE FOR EMPTY CHART STATE --- */
    .empty-chart-state {
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 fw-bold mb-1">Seller Dashboard</h1>
        <p class="mb-0 text-muted">Welcome, {{ session['full_name'].split()[0] }}! Here's an overview of your store's performance.</p>
    </div>
    <a href="{{ url_for('seller_bp.add_product_page') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Add New Product
    </a>
</div>

<!-- Stat Cards Section -->
<div class="row g-4">
    <!-- Total Sales Card -->
    <div class="col-lg col-md-6">
        <div class="stat-card h-100">
            <div class="icon-container icon-sales"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-info">
                <h5>Total Sales Amount</h5>
                <h2 id="total-sales-stat">...</h2>
            </div>
        </div>
    </div>
    <!-- Active Listings Card -->
    <div class="col-lg col-md-6">
        <div class="stat-card h-100">
            <div class="icon-container icon-listings"><i class="fas fa-tags"></i></div>
            <div class="stat-info">
                <h5>Active Listings</h5>
                <h2 id="active-listings-stat">...</h2>
            </div>
        </div>
    </div>
    <!-- --- START: NEW TOTAL PRODUCTS CARD --- -->
    <div class="col-lg col-md-6">
        <a href="{{ url_for('seller_bp.view_products_page') }}" class="text-decoration-none">
            <div class="stat-card h-100">
                <div class="icon-container icon-products"><i class="fas fa-box"></i></div>
                <div class="stat-info">
                    <h5>Total Products</h5>
                    <h2 id="total-products-stat">...</h2>
                </div>
            </div>
        </a>
    </div>
    <!-- --- END: NEW TOTAL PRODUCTS CARD --- -->
    <!-- Cancellation Requests Card -->
    <div class="col-lg col-md-6">
<!-- This is the NEW, CORRECTED line -->
<a href="{{ url_for('seller_bp.seller_manage_orders_page') }}" class="text-decoration-none">            <div class="stat-card h-100">
                <div class="icon-container icon-cancellations"><i class="fas fa-ban"></i></div>
                <div class="stat-info">
                    <h5>Cancellation Requests</h5>
                    <h2 id="cancellation-requests-stat">...</h2>
                </div>
            </div>
        </a>
    </div>
    <!-- Pending Approval Card -->
    <div class="col-lg col-md-6">
        <div class="stat-card h-100">
            <div class="icon-container icon-pending"><i class="fas fa-hourglass-half"></i></div>
            <div class="stat-info">
                <h5>Pending Approval</h5>
                <h2 id="pending-products-stat">...</h2>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<!-- START: Find and REPLACE this entire block -->
<!-- Charts Section -->
<div class="row mt-4 g-4">
    <div class="col-lg-7">
        <!-- ... (old monthly sales card) ... -->
    </div>
    <div class="col-lg-5">
        <!-- ... (old top products card) ... -->
    </div>
</div>
<!-- END: Find and REPLACE this entire block -->


<!-- START: This is the NEW code to paste in its place -->
<!-- Charts Section -->
<div class="row g-4">
    <!-- Monthly Sales Line Chart -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header bg-white py-3"><h4><i class="fas fa-chart-line me-2 text-primary"></i> Monthly Sales</h4></div>
            <div class="card-body d-flex align-items-center justify-content-center p-3">
                <canvas id="salesOverTimeChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <!-- Top Products Bar Chart -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-white py-3"><h4><i class="fas fa-chart-bar me-2 text-primary"></i> Top 5 Products (by units sold)</h4></div>
            <div class="card-body d-flex align-items-center justify-content-center p-3">
                <canvas id="productPerformanceChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <!-- Sales by Category Donut Chart (NEW) -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white py-3"><h4><i class="fas fa-pie-chart me-2 text-primary"></i> Sales by Category</h4></div>
            <div class="card-body d-flex align-items-center justify-content-center p-3">
                <canvas id="salesByCategoryChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <!-- Order Status Pie Chart (NEW) -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white py-3"><h4><i class="fas fa-tasks me-2 text-primary"></i> Order Status Overview</h4></div>
            <div class="card-body d-flex align-items-center justify-content-center p-3">
                <canvas id="orderStatusChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- END: This is the NEW code to paste -->

<!-- RECENT Products List Section (Simplified for dashboard) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-box-open me-2 text-primary"></i> Recently Added Products</h4>
                <a href="{{ url_for('seller_bp.view_products_page') }}" class="btn btn-sm btn-outline-secondary">View All Products</a>
            </div>
            <div class="card-body">
                <div id="delete-alert-placeholder"></div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Product</th>
                                <th>SKU</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Product rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleteModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Product</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let salesChart, performanceChart; 

    function formatNumber(num) {
        return new Intl.NumberFormat('en-US').format(num);
    }

    // --- MODIFIED: Fetches and updates all 5 statistics ---
    function updateStats() {
        $.ajax({
            url: '/seller/api/stats',
            method: 'GET',
            success: function(data) {
                $('#total-sales-stat').text('$' + parseFloat(data.total_sales || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $('#active-listings-stat').text(formatNumber(data.active_listings || 0));
                $('#total-products-stat').text(formatNumber(data.total_products || 0)); // New
                $('#cancellation-requests-stat').text(formatNumber(data.pending_cancellations || 0));
                $('#pending-products-stat').text(formatNumber(data.pending_products || 0));
            },
            error: function() { $('.stat-info h2').text('Error'); }
        });
    }

    // --- REWRITTEN: Creates an attractive and responsive sales line chart ---
    function createSalesChart() {
         $.ajax({
            url: '/seller/api/sales_over_time',
            method: 'GET',
            success: function(data) {
                const canvas = $('#salesOverTimeChart');
                const emptyState = $('#no-sales-data');

                if (!data || data.length === 0) {
                    canvas.hide();
                    emptyState.show();
                    return;
                }
                
                emptyState.hide();
                canvas.show();

                const ctx = canvas[0].getContext('2d');
                if (salesChart) salesChart.destroy();
                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: data.map(d => d.month), 
                        datasets: [{ 
                            label: 'Total Sales', 
                            data: data.map(d => d.monthly_sales), 
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            pointBackgroundColor: '#4361ee',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true, 
                            tension: 0.4 
                        }] 
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Sales: $${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    // --- REWRITTEN: Creates an attractive and responsive top products bar chart ---
    function createPerformanceChart() {
        $.ajax({
            url: '/seller/api/product_performance',
            method: 'GET',
            success: function(data) {
                const canvas = $('#productPerformanceChart');
                const emptyState = $('#no-product-data');

                if (!data || data.length === 0) {
                    canvas.hide();
                    emptyState.show();
                    return;
                }
                
                emptyState.hide();
                canvas.show();

                const ctx = canvas[0].getContext('2d');
                if (performanceChart) performanceChart.destroy();
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: data.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name), 
                        datasets: [{ 
                            label: 'Units Sold', 
                            data: data.map(p => p.sold_count), 
                            backgroundColor: 'rgba(25, 135, 84, 0.7)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }] 
                    },
                    options: {
                        indexAxis: 'y',
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    // --- MODIFIED: Fetches and populates only the 5 most recent products ---
   // This is the NEW, CORRECTED function
function loadProductsTable() {
    const tableBody = $('#products-table-body');
    tableBody.html('<tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>');

    $.ajax({
        url: `{{ url_for('seller_bp.api_get_recent_products') }}`, // <-- CORRECTED URL
        method: 'GET',
        success: function(products) { // This now receives a simple array as expected
            tableBody.empty();
            if (!products || products.length === 0) {
                tableBody.html('<tr><td colspan="6" class="text-center p-5">You have not added any products yet.</td></tr>');
                return;
            }

            // No need to slice, the backend already limited it to 5
            products.forEach(product => {
                let statusBadge;
                if (product.is_approved && product.is_active) {
                    statusBadge = '<span class="badge bg-success-subtle text-success-emphasis">Active</span>';
                } else if (!product.is_approved) {
                    statusBadge = '<span class="badge bg-warning-subtle text-warning-emphasis">Pending</span>';
                } else {
                    statusBadge = '<span class="badge bg-secondary-subtle text-secondary-emphasis">Inactive</span>';
                }
                const imageUrl = product.primary_image ? `/${product.primary_image}` : `{{ url_for('static', filename='images/placeholder.png') }}`;

                const row = `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <img src="${imageUrl}" alt="${product.name}" style="width: 45px; height: 45px; object-fit: cover; border-radius: 8px;" class="me-3">
                                <strong>${product.name}</strong>
                            </div>
                        </td>
                        <td>${product.sku}</td>
                        <td>$${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>${statusBadge}</td>
                        <td class="text-end pe-4">
                            <div class="d-flex align-items-center">
                                <a href="/seller/edit_product/${product.product_id}" class="btn btn-sm btn-outline-secondary me-1" title="Edit Product">
                                    <i class="fas fa-edit"></i>
                                </a>

                                <button class="btn btn-sm btn-outline-danger delete-btn"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteConfirmModal" 
                                    data-productid="${product.product_id}"
                                    data-productname="${product.name}" title="Delete Product">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        },
        error: function() {
            tableBody.html('<tr><td colspan="6" class="text-center text-danger p-5">Failed to load products.</td></tr>');
        }
    });
}

    // Modal Logic for Deleting Products
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    $('#products-table-body').on('click', '.delete-btn', function() {
        const productId = $(this).data('productid');
        const productName = $(this).data('productname');
        $('#deleteModalBody').text(`Are you sure you want to permanently delete "${productName}"? This action cannot be undone.`);
        $('#confirm-delete-btn').data('productId', productId);
    });
    $('#confirm-delete-btn').on('click', function() {
        const productId = $(this).data('productId');
        $.ajax({
            url: `/seller/api/product/${productId}`,
            method: 'DELETE',
            success: function(response) {
                deleteModal.hide();
                showAlert(response.message, 'success');
                loadProductsTable();
                updateStats();
            },
            error: function(xhr) {
                deleteModal.hide();
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "Could not delete product.";
                showAlert(errorMsg, 'danger');
            }
        });
    });












     // --- START: Add these two NEW functions right here ---

    function renderCategorySalesChart() {
        $.get("{{ url_for('seller_bp.api_sales_by_category') }}", function(data) {
            const container = $('#salesByCategoryChart').parent();
            if(!data || data.length === 0) {
                container.html('<div class="empty-chart-state"><i class="fas fa-pie-chart fa-3x mb-3"></i><p>Your sales by category will appear here.</p></div>');
                return;
            }
            const ctx = document.getElementById('salesByCategoryChart').getContext('2d');
            if(window.categoryChart) window.categoryChart.destroy();
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.main_category_name),
                    datasets: [{
                        data: data.map(d => d.total_sales),
                        backgroundColor: ['#4361ee', '#7209b7', '#f72585', '#38b000', '#ffbe0b', '#0096c7'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
    }

    function renderOrderStatusChart() {
        $.get("{{ url_for('seller_bp.api_order_status_summary') }}", function(data) {
            const container = $('#orderStatusChart').parent();
            if(!data || data.length === 0) {
                container.html('<div class="empty-chart-state"><i class="fas fa-tasks fa-3x mb-3"></i><p>Your order status summary will appear here.</p></div>');
                return;
            }
            const ctx = document.getElementById('orderStatusChart').getContext('2d');
            if(window.statusChart) window.statusChart.destroy();
            window.statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(d => d.status_group),
                    datasets: [{
                        data: data.map(d => d.order_count),
                        backgroundColor: ['#ffc107', '#fd7e14', '#198754'], // Colors for To Fulfill, Shipped, Delivered
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
    }
    



























    function showAlert(message, type) {
        const placeholder = $('#delete-alert-placeholder');
        const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                              ${message}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                           </div>`;
        placeholder.html(alertHtml);
        setTimeout(() => { placeholder.find('.alert').alert('close'); }, 5000);
    }

    // Initial load of all dynamic content
    updateStats();
    createSalesChart();
    createPerformanceChart();
    loadProductsTable();
    renderCategorySalesChart(); // <-- ADD THIS LINE
    renderOrderStatusChart();
    
});
</script>
{% endblock %}