{% extends "base.html" %}

{% block title %}Add New Product{% endblock %}

{% block head %}
{{ super() }}
<!-- START: NEW CSS BLOCK FOR FORM FIELD STYLING -->
<style>
    /*
      This targets all standard input fields, textareas, and select dropdowns
      within the form to give them a consistent, modern look.
    */
    #add-product-form .form-control,
    #add-product-form .form-select {
        border: 1px solid #ced4da; /* A standard, visible light-grey border */
        border-radius: 0.375rem;     /* Slightly rounded corners */
        padding: 0.75rem 1rem;       /* Comfortable padding */
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Smooth transition for hover/focus */
    }

    /*
      This is the hover and focus effect.
      When a user hovers over or clicks into a field, the border will turn
      the primary blue color, and a subtle glow (box-shadow) will appear.
    */
    #add-product-form .form-control:hover,
    #add-product-form .form-select:hover,
    #add-product-form .form-control:focus,
    #add-product-form .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25); /* The blue glow effect */
    }
</style>
<!-- END: NEW CSS BLOCK -->
{% endblock %}


{% block content %}
<div class="container-fluid">
    <h1 class="h2 mb-4">Add a New Product</h1>

    <form id="add-product-form" enctype="multipart/form-data">
        <div class="row">
            <!-- Left Column: Main Details -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><h5>Basic Information</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Full Description</label>
                            <textarea class="form-control" id="description" name="description" rows="6"></textarea>
                        </div>
                         <div class="mb-3">
                            <label for="short_description" class="form-label">Short Description (Max 500 chars)</label>
                            <textarea class="form-control" id="short_description" name="short_description" rows="3" maxlength="500"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="video_url" class="form-label">Product Video URL (Optional)</label>
                            <input type="url" class="form-control" id="video_url" name="video_url" placeholder="e.g., https://www.youtube.com/watch?v=...">
                            <div class="form-text">Paste a link to a YouTube, Vimeo, or other video hosting page.</div>
                        </div>

                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><h5>Images</h5></div>
                    <div class="card-body">
                        <label for="images" class="form-label">Upload Product Images (first image is primary)</label>
                        <input class="form-control" type="file" id="images" name="images" multiple accept="image/*" required>
                        <div id="image-preview" class="mt-3 d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Pricing, Category, etc. -->
            <div class="col-lg-4">
                <div class="card mb-4">
                     <div class="card-header"><h5>Organization</h5></div>
                     <div class="card-body">
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU (Stock Keeping Unit)</label>
                            <input type="text" class="form-control" id="sku" name="sku" required>
                            <div class="form-text">Must be unique for each product.</div>
                        </div>

                        <div class="mb-3">
                            <label for="main_category" class="form-label">Main Category</label>
                            <select class="form-select" id="main_category" required>
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <div class="mb-3" id="subcategory-wrapper" style="display: none;">
                            <label for="subcategory" class="form-label">Subcategory</label>
                            <select class="form-select" id="subcategory" required>
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <input type="hidden" id="category_id" name="category_id" value="">
                        
                        <div class="mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" name="brand">
                        </div>
                         <div class="mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model" name="model">
                        </div>
                     </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header"><h5>Pricing & Inventory</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="price" class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="compare_price" class="form-label">Compare Price ($) (Optional)</label>
                            <input type="number" class="form-control" id="compare_price" name="compare_price" step="0.01" min="0">
                        </div>
                         <div class="mb-3">
                            <label for="stock_quantity" class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Product Specifications</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="add-spec-btn"><i class="fas fa-plus"></i> Add Specification</button>
            </div>
            <div class="card-body"><div id="specifications-container"></div></div>
        </div>

        <div class="d-flex justify-content-end mb-5">
            <button type="submit" class="btn btn-primary btn-lg">Add Product</button>
        </div>
    </form>
    <div id="form-message" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // --- Your existing JavaScript is perfect and requires NO CHANGES ---
    let structuredCategories = [];
    const mainCategorySelect = $('#main_category');
    const subcategoryWrapper = $('#subcategory-wrapper');
    const subcategorySelect = $('#subcategory');
    const finalCategoryIdInput = $('#category_id');

    $.ajax({
        url: "/seller/api/categories",
        method: 'GET',
        success: function(data) {
            structuredCategories = data;
            mainCategorySelect.empty().append('<option value="" selected disabled>Select a main category...</option>');
            if (data && data.length > 0) {
                data.forEach(mainCat => {
                    mainCategorySelect.append(new Option(mainCat.name, mainCat.category_id));
                });
            } else {
                 mainCategorySelect.empty().append('<option value="">No categories available</option>');
            }
        },
        error: function() {
            mainCategorySelect.empty().append('<option value="">Error loading categories</option>');
        }
    });

    mainCategorySelect.on('change', function() {
        const selectedMainId = $(this).val();
        subcategorySelect.empty();
        subcategoryWrapper.hide();
        finalCategoryIdInput.val('');
        if (!selectedMainId) return;
        const selectedCategory = structuredCategories.find(cat => cat.category_id == selectedMainId);
        if (selectedCategory && selectedCategory.subcategories && selectedCategory.subcategories.length > 0) {
            subcategorySelect.append('<option value="" selected disabled>Select a subcategory...</option>');
            selectedCategory.subcategories.forEach(subCat => {
                subcategorySelect.append(new Option(subCat.name, subCat.category_id));
            });
            subcategoryWrapper.show();
        } else {
            finalCategoryIdInput.val(selectedMainId);
        }
    });

    subcategorySelect.on('change', function() {
        const selectedSubId = $(this).val();
        if (selectedSubId) {
            finalCategoryIdInput.val(selectedSubId);
        } else {
            finalCategoryIdInput.val('');
        }
    });

    $('#add-product-form').on('submit', function(e) {
        e.preventDefault();
        if (!finalCategoryIdInput.val()) {
            $('#form-message').html('<div class="alert alert-danger">Please select a final category for the product.</div>');
            return;
        }
        const formData = new FormData(this);
        const specifications = [];
        $('.spec-row').each(function() {
            const name = $(this).find('.spec-name').val().trim();
            const value = $(this).find('.spec-value').val().trim();
            if (name && value) { specifications.push({ name, value }); }
        });
        if (specifications.length > 0) {
            formData.append('specifications', JSON.stringify(specifications));
        }
        $.ajax({
            url: "/seller/api/add_product",
            method: 'POST',
            data: formData,
            processData: false, contentType: false,
            success: function(response) {
                $('#form-message').html(`<div class="alert alert-success">${response.message}</div>`);
                $('#add-product-form')[0].reset();
                $('#image-preview').empty();
                $('#specifications-container').empty();
                subcategoryWrapper.hide();
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An unexpected error occurred.";
                $('#form-message').html(`<div class="alert alert-danger">${errorMsg}</div>`);
            }
        });
    });

    $('#images').on('change', function(event) {
        const previewContainer = $('#image-preview');
        previewContainer.empty();
        if (event.target.files) {
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = $('<img>').attr('src', e.target.result).addClass('img-thumbnail').css({width: '100px', height: '100px', objectFit: 'cover'});
                    previewContainer.append(img);
                };
                reader.readAsDataURL(file);
            });
        }
    });

    $('#add-spec-btn').on('click', function() {
        const specHtml = `
            <div class="row mb-2 spec-row">
                <div class="col-5"><input type="text" class="form-control spec-name" placeholder="e.g., Screen Size"></div>
                <div class="col-5"><input type="text" class="form-control spec-value" placeholder="e.g., 6.5 inches"></div>
                <div class="col-2"><button type="button" class="btn btn-danger remove-spec-btn w-100">Remove</button></div>
            </div>`;
        $('#specifications-container').append(specHtml);
    });

    $('#specifications-container').on('click', '.remove-spec-btn', function() { $(this).closest('.spec-row').remove(); });
});
</script>
{% endblock %}