{% extends "base.html" %}

{% block title %}Change Password{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h1 class="h3 mb-0">Change Your Password</h1>
                </div>
                <div class="card-body">
                    <form id="change-password-form">
                        <!-- Old Password -->
                        <div class="mb-3">
                            <label for="old_password" class="form-label">Old Password</label>
                            <input type="password" class="form-control" id="old_password" required>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" required>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" required>
                        </div>

                        <div class="d-grid">
                             <button type="submit" class="btn btn-primary btn-lg">Update Password</button>
                        </div>
                    </form>
                    <!-- Div for showing success or error messages -->
                    <div id="form-message" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const form = $('#change-password-form');
    const formMessageDiv = $('#form-message');
    const newPasswordInput = $('#new_password');
    const confirmPasswordInput = $('#confirm_password');

    form.on('submit', function(e) {
        e.preventDefault();
        formMessageDiv.html(''); // Clear previous messages

        const oldPassword = $('#old_password').val();
        const newPassword = newPasswordInput.val();
        const confirmPassword = confirmPasswordInput.val();

        // --- Client-side validation ---
        if (newPassword.length < 8) {
            formMessageDiv.html('<div class="alert alert-danger">New password must be at least 8 characters long.</div>');
            return;
        }

        if (newPassword !== confirmPassword) {
            formMessageDiv.html('<div class="alert alert-danger">New passwords do not match. Please try again.</div>');
            return;
        }

        // --- AJAX request to the backend ---
        $.ajax({
            url: '/seller/api/change_password',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword
            }),
            success: function(response) {
                formMessageDiv.html(`<div class="alert alert-success">${response.message}</div>`);
                form[0].reset(); // Clear the form fields on success
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An unexpected error occurred.";
                formMessageDiv.html(`<div class="alert alert-danger">${errorMsg}</div>`);
            }
        });
    });
});
</script>
{% endblock %}