{% extends "base.html" %}

{% block title %}Change Password{% endblock %}

{% block head %}
{{ super() }}
<!-- START: NEW CSS BLOCK TO ADD BORDERS -->
<style>
    /*
      This simple rule targets the input fields within our floating label divs
      and adds a standard, light-grey border to them, making them always visible.
    */
    .form-floating > .form-control {
        border: 1px solid #dee2e6;
    }
</style>
<!-- END: NEW CSS BLOCK -->
{% endblock %}


{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">Change Your Password</h1>
            <p class="mb-0 text-muted">For your security, we recommend choosing a strong, unique password.</p>
        </div>
    </div>

    <!-- This div will show success or error messages from form submission -->
    <div id="form-message" class="mb-3"></div>

    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-key me-2"></i>Update Your Security Credentials</h5>
        </div>
        <div class="card-body p-4">
            <!-- The form for updating the password with NEW styling -->
            <form id="change-password-form">

                <!-- MODIFIED INPUT FIELDS WITH FLOATING LABELS -->
                
                <!-- Current Password -->
                <div class="form-floating mb-3">
                    <input type="password" id="old_password" class="form-control" placeholder="Current Password" required>
                    <label for="old_password">Current Password</label>
                </div>

                <!-- New Password -->
                <div class="form-floating mb-3">
                    <input type="password" id="new_password" class="form-control" placeholder="New Password" required>
                    <label for="new_password">New Password</label>
                    <div class="form-text ps-2">
                        Must be at least 8 characters long.
                    </div>
                </div>

                <!-- Confirm New Password -->
                <div class="form-floating mb-3">
                    <input type="password" id="confirm_new_password" class="form-control" placeholder="Confirm New Password" required>
                    <label for="confirm_new_password">Confirm New Password</label>
                </div>

                <!-- END: MODIFIED INPUT FIELDS -->

                <hr class="my-4">

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="save-btn">
                        <span class="btn-text">Update Password</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // --- Your existing JavaScript is perfect and requires NO CHANGES ---
    $('#change-password-form').on('submit', function(e) {
        e.preventDefault();

        const formMessageDiv = $('#form-message');
        const saveButton = $('#save-btn');
        const oldPassword = $('#old_password').val();
        const newPassword = $('#new_password').val();
        const confirmNewPassword = $('#confirm_new_password').val();

        formMessageDiv.html('');

        if (!oldPassword || !newPassword || !confirmNewPassword) {
            formMessageDiv.html('<div class="alert alert-danger">All fields are required.</div>');
            return;
        }
        if (newPassword.length < 8) {
            formMessageDiv.html('<div class="alert alert-danger">New password must be at least 8 characters long.</div>');
            return;
        }
        if (newPassword !== confirmNewPassword) {
            formMessageDiv.html('<div class="alert alert-danger">New passwords do not match.</div>');
            return;
        }

        saveButton.prop('disabled', true).html(`
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="btn-text">Updating...</span>
        `);

        $.ajax({
            url: "{{ url_for('admin_bp.api_admin_change_password') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword
            }),
            success: function(response) {
                formMessageDiv.html(`<div class="alert alert-success alert-dismissible fade show">${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
                $('#change-password-form')[0].reset();
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An unknown error occurred.";
                formMessageDiv.html(`<div class="alert alert-danger alert-dismissible fade show">${errorMsg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
            },
            complete: function() {
                saveButton.prop('disabled', false).html('<span class="btn-text">Update Password</span>');
            }
        });
    });
});
</script>
{% endblock %}