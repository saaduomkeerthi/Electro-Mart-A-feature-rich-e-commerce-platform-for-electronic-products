{% extends "base.html" %}

{% block title %}Manage Store Categories{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">Manage Store Categories</h1>
            <p class="mb-0 text-muted">Edit, delete, and control which categories are available to sellers.</p>
        </div>
        <div>
            <a href="{{ url_for('admin_bp.add_category_page') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Create New Category
            </a>
        </div>
    </div>

    <!-- General Message Area for feedback -->
    <div id="general-message"></div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-sitemap me-2"></i>Category Availability</h5>
            <form id="activation-form">
                 <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Save Visibility Settings</button>
            </form>
        </div>
        <div class="card-body">
            <!-- START: NEW SEARCH FORM -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <form id="search-form">
                        <div class="input-group">
                            <input type="search" id="search-input" class="form-control" placeholder="Search by main category name...">
                            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- END: NEW SEARCH FORM -->

            <div id="category-list-container">
                <!-- Dynamic category list will be rendered here -->
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading Categories...</p>
                </div>
            </div>

            <!-- START: NEW PAGINATION CONTAINER -->
            <nav id="pagination-container" class="mt-4 d-flex justify-content-center">
                <!-- Pagination links will be rendered here -->
            </nav>
            <!-- END: NEW PAGINATION CONTAINER -->
        </div>
    </div>
</div>

<!-- Edit Category Modal (Unchanged) -->
<div class="modal fade" id="edit-category-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edit-modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-category-form">
            <input type="hidden" id="edit-category-id">
            <div class="mb-3">
                <label for="edit-category-name" class="form-label">Category Name</label>
                <input type="text" class="form-control" id="edit-category-name" required>
            </div>
            <div id="edit-form-message"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-category-changes-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const categoryListContainer = $('#category-list-container');
    const paginationContainer = $('#pagination-container');
    const generalMessageDiv = $('#general-message');
    const searchInput = $('#search-input');
    const editCategoryModal = new bootstrap.Modal(document.getElementById('edit-category-modal'));

    // --- 1. FUNCTION TO LOAD AND RENDER THE CATEGORY LIST ---
    function loadCategories(page = 1, search = '') {
        categoryListContainer.html(`
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading Categories...</p>
            </div>`);

        $.ajax({
            url: `{{ url_for('admin_bp.api_get_all_manageable_categories') }}?page=${page}&search=${search}`,
            method: 'GET',
            success: function(response) {
                renderCategoryList(response.categories);
                renderPagination(response.total_pages, response.current_page);
            },
            error: function() {
                categoryListContainer.html('<p class="text-danger text-center">Could not load categories.</p>');
                paginationContainer.empty();
            }
        });
    }

    // --- 2. FUNCTION TO RENDER THE NESTED LIST (Your original UI) ---
    function renderCategoryList(categories) {
        if (!categories || categories.length === 0) {
            categoryListContainer.html('<p class="text-muted text-center mt-3">No categories found matching your search.</p>');
            return;
        }

        let html = '<ul class="list-group list-group-flush">';
        categories.forEach(mainCat => {
            const isChecked = mainCat.is_active ? 'checked' : '';
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${mainCat.category_id}" id="cat-${mainCat.category_id}" ${isChecked}>
                        <label class="form-check-label fw-bold" for="cat-${mainCat.category_id}">${mainCat.name}</label>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${mainCat.category_id}" data-name="${mainCat.name}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${mainCat.category_id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>
            `;

            if (mainCat.subcategories && mainCat.subcategories.length > 0) {
                html += '<li class="list-group-item" style="padding-left: 40px;"><ul class="list-group">';
                mainCat.subcategories.forEach(subCat => {
                    const isSubChecked = subCat.is_active ? 'checked' : '';
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                             <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${subCat.category_id}" id="cat-${subCat.category_id}" ${isSubChecked}>
                                <label class="form-check-label" for="cat-${subCat.category_id}">${subCat.name}</label>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${subCat.category_id}" data-name="${subCat.name}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${subCat.category_id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </li>`;
                });
                html += '</ul></li>';
            }
        });
        html += '</ul>';
        categoryListContainer.html(html);
    }
    
    // --- 3. FUNCTION TO RENDER PAGINATION ---
    function renderPagination(totalPages, currentPage) {
        paginationContainer.empty();
        if (totalPages <= 1) return;

        let paginationHtml = '<ul class="pagination">';
        
        paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;

        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        
        paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
        
        paginationHtml += '</ul>';
        paginationContainer.html(paginationHtml);
    }

    // --- 4. EVENT LISTENERS ---
    
    $('#search-form').on('submit', function(e) {
        e.preventDefault();
        loadCategories(1, searchInput.val());
    });

    paginationContainer.on('click', '.page-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page) {
            loadCategories(page, searchInput.val());
        }
    });

    // Edit and Delete logic (unchanged)
    categoryListContainer.on('click', '.edit-btn', function() {
        const categoryId = $(this).data('id');
        const categoryName = $(this).data('name');
        $('#edit-category-id').val(categoryId);
        $('#edit-category-name').val(categoryName);
        $('#edit-form-message').html('');
        editCategoryModal.show();
    });

    $('#save-category-changes-btn').on('click', function() {
        const categoryId = $('#edit-category-id').val();
        const newName = $('#edit-category-name').val().trim();
        if (!newName) {
            $('#edit-form-message').html('<div class="alert alert-danger">Name cannot be empty.</div>');
            return;
        }
        $.ajax({
            url: "{{ url_for('admin_bp.api_update_category') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ category_id: categoryId, new_name: newName }),
            success: function(response) {
                editCategoryModal.hide();
                generalMessageDiv.html(`<div class="alert alert-success">${response.message}</div>`);
                loadCategories(1, searchInput.val());
            },
            error: function(xhr) {
                $('#edit-form-message').html(`<div class="alert alert-danger">${xhr.responseJSON.error}</div>`);
            }
        });
    });

    categoryListContainer.on('click', '.delete-btn', function() {
        const categoryId = $(this).data('id');
        if (confirm('Are you sure you want to delete this category?')) {
            $.ajax({
                url: "{{ url_for('admin_bp.api_delete_category') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ category_id: categoryId }),
                success: function(response) {
                    generalMessageDiv.html(`<div class="alert alert-success">${response.message}</div>`);
                    loadCategories(1, searchInput.val());
                },
                error: function(xhr) {
                    generalMessageDiv.html(`<div class="alert alert-danger">${xhr.responseJSON.error}</div>`);
                }
            });
        }
    });
    
    // Activation form submission (unchanged)
    $('#activation-form').on('submit', function(e) {
        e.preventDefault();
        let active_ids = [];
        $('#category-list-container input[type=checkbox]:checked').each(function() {
            active_ids.push(parseInt($(this).val()));
        });
        
        $.ajax({
            url: "{{ url_for('admin_bp.api_update_category_status') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ active_ids: active_ids }),
            success: function(response) {
                 generalMessageDiv.html(`<div class="alert alert-success">${response.message}</div>`);
            },
            error: function(xhr) {
                 const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.";
                 generalMessageDiv.html(`<div class="alert alert-danger">${errorMsg}</div>`);
            }
        });
    });

    // --- INITIAL PAGE LOAD ---
    loadCategories();
});
</script>
{% endblock %}