{% extends "public_base.html" %}

{% block title %}Welcome to ElectroMart{% endblock %}

{% block head %}
<!-- Swiper.js CSS is needed for the carousel -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

<style>
    /* --- START: UPDATED CAROUSEL & PAGE STYLES --- */
    .hero-swiper-section { position: relative; width: 100%; height: 580px; overflow: hidden; }
    .swiper-container { width: 100%; height: 100%; }
    .swiper-slide { display: flex; align-items: center; justify-content: center; overflow: hidden; transition: background 0.6s ease; }
    .slide-bg-1 { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
    .slide-bg-2 { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
    .slide-bg-3 { background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); }
    .slide-content { display: grid; grid-template-columns: 40% 60%; align-items: center; width: 100%; height: 100%; max-width: 1250px; margin: 0 auto; padding: 0 2rem; }
    .slide-text { padding: 0 2rem; text-align: left; color: #2d3748; }
    .slide-text h2 { position: relative; display: inline-block; font-size: clamp(1.8rem, 4vw, 2.6rem); font-weight: 700; line-height: 1.25; margin-bottom: 2rem; padding-bottom: 1rem; opacity: 0; transform: translateY(25px); transition: opacity 0.6s ease, transform 0.6s ease; }
    .gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
    .slide-text h2::after { content: ''; position: absolute; bottom: 0; left: 0; height: 4px; width: 0; background: var(--gradient-primary); border-radius: 2px; transition: width 0.8s cubic-bezier(0.23, 1, 0.32, 1); }
    .slide-text p { font-size: 1.1rem; margin-bottom: 2.5rem; color: #6c757d; max-width: 480px; opacity: 0; transform: translateY(25px); transition: opacity 0.6s ease, transform 0.6s ease; }
    .slide-text .btn { opacity: 0; transform: translateY(25px); transition: opacity 0.6s ease, transform 0.6s ease; }
    .swiper-slide-active .slide-text h2 { opacity: 1; transform: translateY(0); transition-delay: 0.3s; }
    .swiper-slide-active .slide-text h2::after { width: 40%; transition-delay: 0.5s; }
    .swiper-slide-active .slide-text p { opacity: 1; transform: translateY(0); transition-delay: 0.45s; }
    .swiper-slide-active .slide-text .btn { opacity: 1; transform: translateY(0); transition-delay: 0.6s; }
    .slide-image-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; }
    .slide-image { max-width: 100%; max-height: 60%; object-fit: contain; filter: drop-shadow(0px 20px 30px rgba(0, 0, 0, 0.15)); transform: translateY(50px) scale(0.9); opacity: 0; transition: all 0.9s cubic-bezier(0.165, 0.84, 0.44, 1); }
    .swiper-slide-active .slide-image { transform: translateY(0) scale(1); opacity: 1; transition-delay: 0.2s; }
    .swiper-button-next, .swiper-button-prev { color: var(--primary-color); --swiper-navigation-size: 22px; background: #fff; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .swiper-pagination-bullet { width: 10px; height: 10px; background: #ccc; opacity: 1; }
    .swiper-pagination-bullet-active { background: var(--primary-color); }
    /* --- END: CAROUSEL STYLES --- */

    /* --- PRODUCT CARD STYLES --- */
    .product-card {
        border: 1px solid #e2e8f0;
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: var(--primary-color);
    }
    .product-card .card-title {
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;  
        overflow: hidden; text-overflow: ellipsis; min-height: 3em;
    }
    .product-card .stretched-link::after {
        position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: 1; content: "";
    }
    .product-card .add-to-cart-btn,
    .product-card .wishlist-toggle-btn {
        position: relative;
        z-index: 2;
    }
    /* --- END: PRODUCT CARD STYLES --- */

    /* === ATTRACTIVE SECTION STYLES === */
    .features-bar-item { text-align: center; }
    .features-bar-item .icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem; }
    .cta-section {
        background: linear-gradient(135deg, #4361ee, #3a0ca3);
        color: #fff;
        border-radius: var(--border-radius-lg);
    }
    .brand-logo { filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
    .brand-logo:hover { filter: grayscale(0%); opacity: 1; }
    .testimonial-card { border-left: 4px solid var(--primary-color); }
    .testimonial-card .stars { color: #ffc107; }

    /* --- START: NEW BANNER STYLE --- */
    .promo-banner {
        background: linear-gradient(135deg, #f72585, #7209b7);
        color: white;
        border-radius: var(--border-radius-lg);
        animation: fadeIn 1s ease-in-out;
    }
    /* --- END: NEW BANNER STYLE --- */
</style>
{% endblock %}

{% block content %}
<!-- CAROUSEL -->
<div class="hero-swiper-section shadow-sm">
    <div class="swiper-container">
        <div class="swiper-wrapper"><!-- Slides will be injected here by JavaScript --></div>
        <div class="swiper-button-prev"></div><div class="swiper-button-next"></div><div class="swiper-pagination"></div>
    </div>
</div>

<div class="container py-5">

    <!-- === START: NEW PROMOTIONAL BANNER === -->
    <div class="promo-banner p-4 my-5 text-center shadow-lg">
        <h3 class="fw-bold mb-1">Welcome to Our Grand Opening!</h3>
        <p class="lead mb-0">
            Get an exclusive <strong class="text-warning">10% OFF</strong> your first order with code: 
            <strong class="text-warning" style="user-select: all;">WELCOME10</strong>
        </p>
    </div>
    <!-- === END: NEW PROMOTIONAL BANNER === -->
    
    <!-- Features Bar -->
    <div class="row g-4 mb-5">
        <div class="col-md-4 features-bar-item">
            <div class="icon"><i class="fas fa-shipping-fast"></i></div>
            <h5 class="fw-bold">Fast Shipping</h5>
            <p class="text-muted small">Get your orders delivered promptly.</p>
        </div>
        <div class="col-md-4 features-bar-item">
            <div class="icon"><i class="fas fa-shield-alt"></i></div>
            <h5 class="fw-bold">Secure Payments</h5>
            <p class="text-muted small">Your transactions are safe with us.</p>
        </div>
        <div class="col-md-4 features-bar-item">
            <div class="icon"><i class="fas fa-headset"></i></div>
            <h5 class="fw-bold">24/7 Support</h5>
            <p class="text-muted small">We're here to help anytime.</p>
        </div>
    </div>
    <!-- END: Features Bar -->

    <!-- DYNAMIC PRODUCT FILTER SECTION -->
    <div class="container-fluid">
        <h2 class="text-center mb-5 section-title">Featured Products</h2>
        <section id="category-filters" class="mb-4 d-flex justify-content-center">
            <div id="category-buttons" class="btn-group flex-wrap justify-content-center" role="group"><div class="spinner-border spinner-border-sm"></div></div>
        </section>
        <section id="all-products">
            <div id="product-list" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                <div class="text-center w-100 py-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>
            </div>
        </section>
    </div>

    <!-- "Deal of the Day" Section -->
    <div class="cta-section p-5 my-5 rounded-3 shadow-lg">
        <div class="row align-items-center">
            <div class="col-lg-7 text-center text-lg-start">
                <h1 class="display-4 fw-bold lh-1">Deal of the Day</h1>
                <p class="lead">Get the new Gaming Laptop Pro with a 20% discount, only for today. Experience unparalleled performance and stunning graphics. Don't miss out!</p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="button" class="btn btn-light btn-lg px-4 me-md-2">Shop Now</button>
                    <button type="button" class="btn btn-outline-light btn-lg px-4">Learn More</button>
                </div>
            </div>
            <div class="col-lg-4 offset-lg-1 d-none d-lg-block">
                <img class="img-fluid" src="https://via.placeholder.com/400x300.png/000000/FFFFFF/?text=Gaming+Laptop" alt="Deal of the Day Image" style="border-radius: 15px;">
            </div>
        </div>
    </div>
    <!-- END: "Deal of the Day" Section -->

    <!-- "Shop by Brand" Section -->
    <div class="my-5">
        <h2 class="text-center mb-5 section-title">Shop by Brand</h2>
        <div class="d-flex flex-wrap justify-content-around align-items-center">
            <i class="fab fa-apple fa-3x m-3 brand-logo" title="Apple"></i>
            <i class="fab fa-windows fa-3x m-3 brand-logo" title="Microsoft"></i>
            <i class="fas fa-gamepad fa-3x m-3 brand-logo" title="Gaming Co."></i>
            <i class="fas fa-satellite-dish fa-3x m-3 brand-logo" title="Connect Inc."></i>
            <i class="fas fa-camera-retro fa-3x m-3 brand-logo" title="PhotoGear"></i>
        </div>
    </div>
    <!-- END: "Shop by Brand" Section -->

    <!-- Testimonials Section -->
    <div class="my-5">
        <h2 class="text-center mb-5 section-title">What Our Customers Say</h2>
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card h-100 testimonial-card">
                    <div class="card-body">
                        <div class="stars mb-2">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                        <p class="card-text">"Amazing products and lightning-fast delivery. I couldn't be happier with my purchase!"</p>
                        <footer class="blockquote-footer mt-2">Jane Doe</footer>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100 testimonial-card">
                    <div class="card-body">
                        <div class="stars mb-2">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                        <p class="card-text">"The customer support was incredibly helpful in guiding me to the perfect laptop for my needs."</p>
                        <footer class="blockquote-footer mt-2">John Smith</footer>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100 testimonial-card">
                    <div class="card-body">
                        <div class="stars mb-2">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                        </div>
                        <p class="card-text">"Great prices and a huge selection. Will definitely be shopping here again for all my electronics."</p>
                        <footer class="blockquote-footer mt-2">Sam Wilson</footer>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Testimonials Section -->
</div>


<!-- LOGIN MODAL -->
<div class="modal fade" id="loginPromptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Authentication Required</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p>Please log in or register to add items to your cart or wishlist.</p></div>
      <div class="modal-footer">
        <a href="{{ url_for('auth_bp.login') }}" class="btn btn-primary">Login</a>
        <a href="{{ url_for('auth_bp.register') }}" class="btn btn-secondary">Register</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Swiper.js Script -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
$(document).ready(function() {
    const loginPromptModal = new bootstrap.Modal(document.getElementById('loginPromptModal'));

    function initializeSwiper(carouselProducts) {
        const swiperWrapper = $('.swiper-wrapper');
        if (!carouselProducts || carouselProducts.length === 0) return;
        swiperWrapper.empty();
        carouselProducts.forEach((product, index) => {
            const imageUrl = product.image_url ? `/${product.image_url}` : `{{ url_for('static', filename='images/placeholder.png') }}`;
            const productUrl = `/product/${product.product_id}`;
            const bgClass = `slide-bg-${(index % 3) + 1}`;
            const slideHtml = `<div class="swiper-slide ${bgClass}"><div class="slide-content"><div class="slide-text"><h2><span class="gradient-text">${product.name}</span></h2><p>${product.short_description || 'The latest in high-performance tech is now available.'}</p><a href="${productUrl}" class="btn btn-primary btn-lg">Shop Now <i class="fas fa-arrow-right ms-1"></i></a></div><div class="slide-image-wrapper"><img src="${imageUrl}" class="slide-image" alt="${product.name}"></div></div></div>`;
            swiperWrapper.append(slideHtml);
        });
        new Swiper('.swiper-container', { loop: true, autoplay: { delay: 5500, disableOnInteraction: false }, navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' }, pagination: { el: '.swiper-pagination', clickable: true }, effect: 'fade', fadeEffect: { crossFade: true } });
    }

    let allProducts = [];
    function renderProducts(productsToRender) {
        const productList = $('#product-list');
        productList.empty();
        if (!productsToRender || productsToRender.length === 0) {
            productList.html('<div class="col-12"><div class="alert alert-info text-center">No products found.</div></div>');
            return;
        }
        productsToRender.forEach(function(product) {
            const imageUrl = product.image_url ? `/${product.image_url}` : `{{ url_for('static', filename='images/placeholder.png') }}`;
            const productCardHtml = `
                <div class="col">
                    <div class="card h-100 d-flex flex-column product-card">
                        <div class="position-relative">
                            <a href="/product/${product.product_id}">
                                <img src="${imageUrl}" class="card-img-top p-3" alt="${product.name}" style="height: 220px; object-fit: contain;">
                            </a>
                            <button class="btn btn-sm btn-outline-danger wishlist-toggle-btn position-absolute top-0 end-0 m-2" title="Add to Wishlist" data-product-id="${product.product_id}"><i class="far fa-heart"></i></button>
                        </div>
                        <div class="card-body d-flex flex-column flex-grow-1 p-3">
                            <div class="flex-grow-1">
                                <h5 class="card-title"><a href="/product/${product.product_id}" class="text-decoration-none text-dark stretched-link">${product.name}</a></h5>
                            </div>
                            <div>
                                <p class="card-text fw-bold text-primary fs-5 mb-2">$${parseFloat(product.price).toFixed(2)}</p>
                                <button class="btn btn-sm btn-primary add-to-cart-btn w-100" data-product-id="${product.product_id}"><i class="fas fa-cart-plus me-2"></i>Add to Cart</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            productList.append(productCardHtml);
        });
    }

    function loadPageData() {
        // --- THIS IS THE CORRECTED LINE ---
        $.ajax({ url: "{{ url_for('api_carousel_products') }}", method: 'GET', success: initializeSwiper });
        
        $.ajax({ url: "{{ url_for('api_categories') }}", method: 'GET',
            success: function(categories) {
                const categoryButtons = $('#category-buttons');
                categoryButtons.empty().append('<button type="button" class="btn btn-primary active m-1" data-category-id="all">All</button>');
                categories.forEach(category => categoryButtons.append(`<button type="button" class="btn btn-outline-primary m-1" data-category-id="${category.category_id}">${category.name}</button>`));
            }
        });
        $.ajax({ url: "{{ url_for('home_bp.api_get_all_products') }}", method: 'GET',
            success: function(products) {
                allProducts = products;
                renderProducts(products);
            }
        });
    }

    $('#category-buttons').on('click', 'button', function() {
        const selectedCategoryId = $(this).data('category-id');
        $('#category-buttons button').removeClass('active btn-primary').addClass('btn-outline-primary');
        $(this).removeClass('btn-outline-primary').addClass('active btn-primary');
        if (selectedCategoryId === 'all') {
            renderProducts(allProducts);
        } else {
            const filteredProducts = allProducts.filter(p => p.category_id == selectedCategoryId || p.parent_category_id == selectedCategoryId);
            renderProducts(filteredProducts);
        }
    });

    $('#product-list').on('click', '.add-to-cart-btn, .wishlist-toggle-btn', function() {
        loginPromptModal.show();
    });
    
    loadPageData();
});
</script>
{% endblock %}