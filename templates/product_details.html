{% extends "base.html" if session.user_id else "public_base.html" %}

{% block title %}{{ product_details.product.name }} - ElectroMart{% endblock %}

{% block head %}
{{ super() }}
<style>
    #product-name {
        font-size: 1.75rem;
        font-weight: 600;
    }
    #product-price {
        font-size: 1.5rem;
    }
    #product-short-description {
        font-size: 1rem;
        color: #6c757d;
    }
    .related-product-card {
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
    }
    .related-product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .related-product-card .card-img-top {
        height: 150px;
        object-fit: contain;
        padding: 0.5rem;
    }
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        border-radius: 0.375rem;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .custom-video-thumb {
        height: 100px; width: 100%; background-color: #f8f9fa; border: 1px solid #dee2e6;
        border-radius: 0.375rem; display: flex; flex-direction: column; align-items: center;
        justify-content: center; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .custom-video-thumb:hover { background-color: #e9ecef; border-color: #adb5bd; }
    .custom-video-thumb i { font-size: 2.5rem; color: #6c757d; }
    .custom-video-thumb span { font-size: 0.8rem; font-weight: 600; color: #495057; margin-top: 5px; text-transform: uppercase; }

    /* --- CSS FOR SELLER INFO BOX --- */
    .seller-info-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .seller-logo {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 0.25rem;
        margin-right: 1rem;
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">
    <div id="product-display-container">
        <div class="row">
            <!-- Product Images Column -->
            <div class="col-md-6">
                <div id="main-display-area" class="mb-3 rounded shadow-sm" style="min-height: 450px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                    <img id="main-product-image"
                         src="{% if product_details.images %}/{{ product_details.images[0].image_url }}{% else %}{{ url_for('static', filename='images/placeholder.png') }}{% endif %}"
                         class="img-fluid"
                         style="max-height: 450px; width: 100%; object-fit: contain;"
                         alt="{{ product_details.product.name }}">
                    <div id="main-product-video" class="video-container w-100" style="display: none;"></div>
                </div>
                <div class="row g-2" id="product-thumbnails">
                    <!-- Thumbnails populated by JS -->
                </div>
            </div>

            <!-- Product Details Column -->
            <div class="col-md-6">
                <h2 class="mb-3" id="product-name">{{ product_details.product.name }}</h2>
                <p class="text-muted" id="product-meta">Brand: {{ product_details.product.brand }} | Category: {{ product_details.product.category_name }}</p>
                <h3 class="my-4 text-primary fw-bold" id="product-price">${{ "%.2f"|format(product_details.product.price) }}</h3>
                <p class="lead mb-4" id="product-short-description">{{ product_details.product.short_description }}</p>
                
                <!-- SELLER INFO BOX -->
                <div class="seller-info-box d-flex align-items-center mb-4">
                    {% set logo_url = product_details.product.logo_url %}
                    <img src="{{ '/' + logo_url if logo_url else url_for('static', filename='images/placeholder_store.png') }}" 
                         alt="{{ product_details.product.business_name }} Logo" 
                         class="seller-logo">
                    <div>
                        <small class="text-muted d-block">Sold by:</small>
                        <h6 class="mb-0 fw-bold">{{ product_details.product.business_name }}</h6>
                    </div>
                </div>
                
                <hr>
                <div class="d-flex align-items-center mb-4">
                    <label for="quantity" class="form-label me-3 mb-0">Quantity:</label>
                    <input type="number" id="quantity" class="form-control" value="1" min="1" max="{{ product_details.product.stock_quantity }}" style="width: 100px;">
                </div>
                <div class="d-flex align-items-center my-4">
                    <button class="btn btn-primary btn-lg flex-grow-1" id="add-to-cart-btn" data-product-id="{{ product_details.product.product_id }}">
                        <i class="fas fa-cart-plus me-2"></i> Add to Cart
                    </button>
                    <button class="btn btn-outline-danger btn-lg ms-3" id="wishlist-toggle-btn" title="Add to Wishlist" data-product-id="{{ product_details.product.product_id }}">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
                <div id="action-message-container" class="mt-3"></div>
                <div class="mt-4" id="product-stock-status">
                    {% if product_details.product.stock_quantity > 10 %}
                        <span class="badge bg-success fs-6">In Stock</span>
                    {% elif product_details.product.stock_quantity > 0 %}
                        <span class="badge bg-warning text-dark fs-6">Low Stock</span>
                    {% else %}
                        <span class="badge bg-danger fs-6">Out of Stock</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs" id="product-info-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#description-content">Full Description</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#specs-content">Specifications</button></li>
                </ul>
                <div class="tab-content p-4 border border-top-0" id="product-info-content">
                    <div class="tab-pane fade show active" id="description-content">{{ product_details.product.description | safe }}</div>
                    <div class="tab-pane fade" id="specs-content">
                        <table class="table table-striped">
                            <tbody id="product-specs-body">
                                {% for spec in product_details.specifications %}
                                <tr>
                                    <th style="width: 30%;">{{ spec.spec_name }}</th>
                                    <td>{{ spec.spec_value }}</td>
                                </tr>
                                {% else %}
                                <tr><td>No specifications available.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">You might also like</h3>
            <div id="related-products-container" class="row g-4">
                <div class="text-center w-100"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginPromptModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Authentication Required</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p>Please log in or register to continue.</p></div>
      <div class="modal-footer">
        <a href="{{ url_for('auth_bp.login') }}" class="btn btn-primary">Login</a>
        <a href="{{ url_for('auth_bp.register') }}" class="btn btn-secondary">Register</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
    function showImage(imageUrl) {
        const videoPlayer = $('#main-product-video');
        const imageViewer = $('#main-product-image');
        videoPlayer.find('iframe').remove(); // More robust cleanup
        videoPlayer.hide();
        imageViewer.attr('src', imageUrl);
        imageViewer.show();
    }

    function showVideo(embedUrl) {
        const videoPlayer = $('#main-product-video');
        const imageViewer = $('#main-product-image');
        imageViewer.hide();
        videoPlayer.html(`<iframe src="${embedUrl}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`);
        videoPlayer.show();
    }

    $(document).ready(function() {
        // --- This section contains the complete, restored JavaScript ---
        let currentProductId = {{ product_details.product.product_id }};
        const messageContainer = $('#action-message-container');
        const loginPromptModal = new bootstrap.Modal(document.getElementById('loginPromptModal'));

        function getYoutubeEmbedUrl(url) {
            if (!url) return null;
            let videoId = '';
            const youtubeRegex = /^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(youtubeRegex);
            if (match && match[1]) {
                videoId = match[1];
            } else {
                return null;
            }
            return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
        }

        // Simplified function that just loads the data without trying to re-render everything
        function populateInitialData() {
            const thumbnailsContainer = $('#product-thumbnails');
            thumbnailsContainer.empty();
            
            // Populate image thumbnails
            const images = {{ product_details.images | tojson }};
            if (images && images.length > 0) {
                images.forEach(image => {
                    const imageUrl = `/${image.image_url}`;
                    thumbnailsContainer.append(`
                        <div class="col-3">
                            <img src="${imageUrl}" class="img-thumbnail" style="cursor:pointer; height: 100px; width: 100%; object-fit: cover;" onclick="showImage('${imageUrl}')">
                        </div>
                    `);
                });
            }

            // Populate video thumbnail if URL exists
            const videoUrl = "{{ product_details.product.video_url or '' }}";
            const embedUrl = getYoutubeEmbedUrl(videoUrl);
            if (embedUrl) {
                thumbnailsContainer.append(`
                    <div class="col-3">
                        <div class="custom-video-thumb" onclick="showVideo('${embedUrl}')">
                            <i class="fas fa-play-circle"></i>
                            <span>VIDEO</span>
                        </div>
                    </div>
                `);
            }
        }

        function loadRelatedProducts(productId) {
            const container = $('#related-products-container');
            $.ajax({
                url: `/api/product/${productId}/related`,
                method: 'GET',
                success: function(products) {
                    container.empty();
                    if (products && products.length > 0) {
                        products.forEach(product => {
                            const imageUrl = product.image_url ? `/${product.image_url}` : "{{ url_for('static', filename='images/placeholder.png') }}";
                            // For related products, clicking them should redirect the page
                            container.append(`
                                <div class="col-md-3">
                                    <a href="/product/${product.product_id}" class="text-decoration-none">
                                        <div class="card h-100 related-product-card">
                                            <img src="${imageUrl}" class="card-img-top" alt="${product.name}">
                                            <div class="card-body">
                                                <h6 class="card-title text-dark">${product.name}</h6>
                                                <p class="card-text fw-bold text-primary">$${parseFloat(product.price).toFixed(2)}</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            `);
                        });
                    } else {
                        container.html('<p class="text-muted">No related products found.</p>');
                    }
                }
            });
        }
        
        function showMessage(text, type) { 
            messageContainer.html(`<div class="alert alert-${type} alert-dismissible fade show">${text}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`); 
            setTimeout(() => { messageContainer.find('.alert').fadeOut(500, function() { $(this).remove(); }); }, 3000);
        }

        {% if session.user_id %}
        function updateWishlistButtonUI(isInWishlist) {
            const wishlistBtn = $('#wishlist-toggle-btn');
            const wishlistIcon = wishlistBtn.find('i');
            if (isInWishlist) {
                wishlistBtn.removeClass('btn-outline-danger').addClass('btn-danger');
                wishlistIcon.removeClass('far').addClass('fas');
                wishlistBtn.attr('title', 'Remove from Wishlist');
            } else {
                wishlistBtn.removeClass('btn-danger').addClass('btn-outline-danger');
                wishlistIcon.removeClass('fas').addClass('far');
                wishlistBtn.attr('title', 'Add to Wishlist');
            }
        }
        function checkWishlistStatus(productId) {
            $.ajax({
                url: "{{ url_for('buyer_bp.api_get_wishlist_status') }}",
                method: 'POST', contentType: 'application/json',
                data: JSON.stringify({ product_ids: [productId] }),
                success: (response) => updateWishlistButtonUI(response[productId])
            });
        }
        $('#wishlist-toggle-btn').on('click', function() {
            const productId = $(this).data('product-id');
            $.ajax({
                url: "{{ url_for('buyer_bp.api_toggle_wishlist') }}",
                method: 'POST', contentType: 'application/json',
                data: JSON.stringify({ product_id: productId }),
                success: (response) => {
                    updateWishlistButtonUI(response.status);
                    showMessage(response.message, 'info');
                },
                error: (xhr) => showMessage(xhr.responseJSON.error || 'An error occurred', 'danger')
            });
        });
        $('#add-to-cart-btn').on('click', function() {
            const productId = $(this).data('product-id');
            const quantity = $('#quantity').val();
            $.ajax({
                url: "{{ url_for('buyer_bp.api_add_to_cart') }}",
                method: 'POST', contentType: 'application/json',
                data: JSON.stringify({ product_id: productId, quantity: parseInt(quantity) }),
                success: (response) => {
                    showMessage(response.message, 'success');
                    if (typeof updateCartCount === 'function') updateCartCount();
                },
                error: (xhr) => showMessage(xhr.responseJSON.error || 'An error occurred', 'danger')
            });
        });
        checkWishlistStatus(currentProductId);
        {% else %}
        $('#add-to-cart-btn, #wishlist-toggle-btn').on('click', () => loginPromptModal.show());
        {% endif %}
        
        // --- FINAL INITIALIZATION CALLS ---
        populateInitialData();
        loadRelatedProducts(currentProductId);
    });
</script>
{% endblock %}